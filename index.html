<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karel Robot Game - Hand Gesture Control</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 50%, #ff2d2d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            color: white;
            margin-bottom: 30px;
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            text-shadow: 0 4px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.5px;
        }

        .game-container {
            display: flex;
            gap: 25px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            /* max-width: 1400px; */
            width: 100%;
        }

        .grid-container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .grid-title {
            text-align: center;
            margin-bottom: 20px;
            color: #ff4757;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(8, 55px);
            grid-template-rows: repeat(8, 55px);
            gap: 2px;
            background-color: #ff4757;
            border-radius: 12px;
            padding: 8px;
        }

        .cell {
            width: 55px;
            height: 55px;
            background-color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(255,71,87,0.3);
        }

        .karel {
            width: 35px;
            height: 35px;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            border-radius: 50%;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            z-index: 10;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(255,71,87,0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .karel.north::after { content: "↑"; }
        .karel.east::after { content: "→"; }
        .karel.south::after { content: "↓"; }
        .karel.west::after { content: "←"; }

        .beeper {
            width: 25px;
            height: 25px;
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border-radius: 50%;
            border: 3px solid white;
            position: absolute;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(0,212,255,0.4);
            animation: sparkle 2s infinite alternate;
        }

        @keyframes sparkle {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.15) rotate(180deg); }
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            max-width: 30em;
        }

        .controls h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #ff4757;
            font-size: 1.4rem;
            font-weight: 600;
            text-align: center;
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 4px 0;
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,71,87,0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .camera-container {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            text-align: center;
            min-width: 360px;
        }

        .camera-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #ff4757;
            font-size: 1.4rem;
            font-weight: 600;
        }

        #video {
            width: 320px;
            height: 240px;
            border: 3px solid #ff4757;
            border-radius: 15px;
            transform: scaleX(-1);
            box-shadow: 0 8px 25px rgba(255,71,87,0.3);
        }

        .gesture-status {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 15px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255,71,87,0.3);
        }

        .info {
            background: linear-gradient(135deg, #f1f2f6, #ddd);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            font-size: 14px;
            border-left: 4px solid #ff4757;
        }

        .info strong {
            color: #ff4757;
        }

        .status {
            background: white;
            border: 2px solid #ff4757;
            color: #ff4757;
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .beeper-count {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            text-align: center;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 4px 15px rgba(255,71,87,0.3);
        }

        .toggle-button {
            background: linear-gradient(45deg, #00d4ff, #0099cc) !important;
            margin-bottom: 15px;
        }

        .toggle-button:hover {
            box-shadow: 0 8px 25px rgba(0,212,255,0.4);
        }

        .gesture-guide {
            background: linear-gradient(135deg, #f1f2f6, #ddd);
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
            border-left: 4px solid #ff4757;
        }

        .gesture-guide strong {
            color: #ff4757;
            font-size: 16px;
        }

        .loading {
            color: rgba(255,255,255,0.8);
            font-style: italic;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
                margin-bottom: 20px;
            }

            .game-container {
                gap: 20px;
            }

            .grid {
                grid-template-columns: repeat(8, 45px);
                grid-template-rows: repeat(8, 45px);
            }

            .cell {
                width: 45px;
                height: 45px;
            }

            .karel {
                width: 30px;
                height: 30px;
            }

            .controls, .camera-container {
                min-width: auto;
                width: 100%;
                max-width: 400px;
            }

            #video {
                width: 280px;
                height: 210px;
            }
        }

        /* Floating animations */
        .grid-container {
            animation: float 6s ease-in-out infinite;
        }

        .controls {
            animation: float 6s ease-in-out infinite 1s;
        }

        .camera-container {
            animation: float 6s ease-in-out infinite 2s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Success/Error animations */
        .status.success {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border-color: #00d4ff;
            animation: successPulse 0.6s ease;
        }

        .status.error {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            border-color: #ff6b6b;
            animation: errorShake 0.6s ease;
        }

        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes errorShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
    <h1>🤖 Karel Robot Game</h1>
    
    <div class="game-container">
        <div class="grid-container">
            <div class="grid-title">Game World</div>
            <div class="grid" id="grid"></div>
        </div>

        <div class="camera-container">
            <h3>📷 Camera Feed</h3>
            <video id="video" autoplay muted></video>
            <div class="gesture-status" id="gestureStatus">
                <span class="loading">Click "Enable Gesture Control" to start</span>
            </div>
        </div>
        
        <div class="controls">
            <h3>🎮 Karel Commands</h3>
            <button class="toggle-button" onclick="toggleGestureControl()" id="gestureToggle">
                🤚 Enable Gesture Control
            </button>
            <button onclick="move()">⬆️ move()</button>
            <button onclick="turnLeft()">↩️ turnLeft()</button>
            <button onclick="turnRight()">↪️ turnRight()</button>
            <button onclick="pickBeeper()">📦 pickBeeper()</button>
            <button onclick="putBeeper()">📤 putBeeper()</button>
            
            <div class="beeper-count">
                💎 Beepers: <span id="beeperCount">5</span>
            </div>
            
            <div class="status" id="status">🚀 Ready to start!</div>
            
            <div class="gesture-guide">
                <strong>🤚 Hand Gestures:</strong><br>
                👆 Point finger up → move()<br>
                ✋ Open hand left → turnLeft()<br>
                ✋ Open hand right → turnRight()<br>
                👍 Thumbs up → pickBeeper()<br>
                ✊ Closed fist → putBeeper()
            </div>
            
            <div class="info">
                <strong>⌨️ Keyboard shortcuts:</strong><br>
                W/↑ - move()<br>
                A/← - turnLeft()<br>
                D/→ - turnRight()<br>
                S/↓ - pickBeeper()<br>
                Space - putBeeper()
            </div>
        </div>
        
        
    </div>

    <script>
        // Game state
        let karel = {
            x: 0,
            y: 7,
            direction: 'east',
            beepers: 5
        };

        const gridSize = 8;
        let grid = [];
        let gameGrid;
        
        // Gesture control variables
        let gestureEnabled = false;
        let video, hands;
        let lastGesture = '';
        let gestureDebounce = false;
        let gestureTimeout;

        // Initialize the game
        function initGame() {
            gameGrid = document.getElementById('grid');
            
            for (let row = 0; row < gridSize; row++) {
                grid[row] = [];
                for (let col = 0; col < gridSize; col++) {
                    grid[row][col] = { hasBeeper: false };
                    
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `cell-${col}-${row}`;
                    gameGrid.appendChild(cell);
                }
            }
            
            addInitialBeepers();
            updateDisplay();
        }

        function addInitialBeepers() {
            const beeperPositions = [
                {x: 3, y: 3}, {x: 5, y: 1}, {x: 2, y: 6}, 
                {x: 6, y: 4}, {x: 1, y: 2}
            ];
            
            beeperPositions.forEach(pos => {
                if (pos.x < gridSize && pos.y < gridSize) {
                    grid[pos.y][pos.x].hasBeeper = true;
                }
            });
        }

        function updateDisplay() {
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    const cell = document.getElementById(`cell-${col}-${row}`);
                    cell.innerHTML = '';
                    
                    if (grid[row][col].hasBeeper) {
                        const beeper = document.createElement('div');
                        beeper.className = 'beeper';
                        cell.appendChild(beeper);
                    }
                }
            }
            
            const karelCell = document.getElementById(`cell-${karel.x}-${karel.y}`);
            const karelElement = document.createElement('div');
            karelElement.className = `karel ${karel.direction}`;
            karelCell.appendChild(karelElement);
            
            document.getElementById('beeperCount').textContent = karel.beepers;
        }

        function setStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status';
            
            if (isError) {
                status.classList.add('error');
            } else {
                status.classList.add('success');
            }
            
            // Remove animation classes after animation completes
            setTimeout(() => {
                status.classList.remove('success', 'error');
            }, 600);
        }

        // Karel commands
        function move() {
            let newX = karel.x;
            let newY = karel.y;
            
            switch (karel.direction) {
                case 'north': newY--; break;
                case 'east': newX++; break;
                case 'south': newY++; break;
                case 'west': newX--; break;
            }
            
            if (newX < 0 || newX >= gridSize || newY < 0 || newY >= gridSize) {
                setStatus("🚫 Can't move - wall ahead!", true);
                return;
            }
            
            karel.x = newX;
            karel.y = newY;
            setStatus(`✅ Moved ${karel.direction} to (${karel.x}, ${karel.y})`);
            updateDisplay();
        }

        function turnLeft() {
            const directions = ['north', 'west', 'south', 'east'];
            const currentIndex = directions.indexOf(karel.direction);
            karel.direction = directions[(currentIndex + 1) % 4];
            setStatus(`🔄 Turned left, now facing ${karel.direction}`);
            updateDisplay();
        }

        function turnRight() {
            const directions = ['north', 'east', 'south', 'west'];
            const currentIndex = directions.indexOf(karel.direction);
            karel.direction = directions[(currentIndex + 1) % 4];
            setStatus(`🔄 Turned right, now facing ${karel.direction}`);
            updateDisplay();
        }

        function pickBeeper() {
            if (grid[karel.y][karel.x].hasBeeper) {
                grid[karel.y][karel.x].hasBeeper = false;
                karel.beepers++;
                setStatus(`💎 Picked up beeper! Total: ${karel.beepers}`);
                updateDisplay();
            } else {
                setStatus("❌ No beeper here to pick up!", true);
            }
        }

        function putBeeper() {
            if (karel.beepers > 0) {
                if (!grid[karel.y][karel.x].hasBeeper) {
                    grid[karel.y][karel.x].hasBeeper = true;
                    karel.beepers--;
                    setStatus(`📤 Put down beeper! Remaining: ${karel.beepers}`);
                    updateDisplay();
                } else {
                    setStatus("⚠️ There's already a beeper here!", true);
                }
            } else {
                setStatus("🚫 No beepers in bag!", true);
            }
        }

        // Gesture recognition functions
        async function setupCamera() {
            video = document.getElementById('video');
            try {
                console.log('Requesting camera access...');
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 320 },
                        height: { ideal: 240 },
                        facingMode: 'user',
                        frameRate: { ideal: 30 }
                    } 
                });
                video.srcObject = stream;
                console.log('Camera access granted');
                return new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        console.log('Video metadata loaded');
                        resolve(video);
                    };
                });
            } catch (error) {
                console.error('Error accessing camera:', error);
                updateGestureStatus('📷 Camera access denied: ' + error.message);
                return null;
            }
        }

        function setupHandDetection() {
            hands = new Hands({
                locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
            });
            
            hands.setOptions({
                maxNumHands: 1,
                modelComplexity: 0,
                minDetectionConfidence: 0.7,
                minTrackingConfidence: 0.5
            });
            
            hands.onResults(onResults);
            
            const camera = new Camera(video, {
                onFrame: async () => {
                    await hands.send({ image: video });
                },
                width: 320,
                height: 240
            });
            
            camera.start();
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const gesture = recognizeGesture(landmarks);
                processGesture(gesture);
            } else {
                updateGestureStatus('👋 Show your hand to the camera');
            }
        }

        function recognizeGesture(landmarks) {
            // Get key landmarks
            const thumb_tip = landmarks[4];
            const index_tip = landmarks[8];
            const middle_tip = landmarks[12];
            const ring_tip = landmarks[16];
            const pinky_tip = landmarks[20];
            
            const thumb_mcp = landmarks[2];
            const index_mcp = landmarks[5];
            const middle_mcp = landmarks[9];
            const ring_mcp = landmarks[13];
            const pinky_mcp = landmarks[17];
            
            // Check if fingers are extended
            const thumbUp = thumb_tip.y < thumb_mcp.y;
            const indexUp = index_tip.y < index_mcp.y;
            const middleUp = middle_tip.y < middle_mcp.y;
            const ringUp = ring_tip.y < ring_mcp.y;
            const pinkyUp = pinky_tip.y < pinky_mcp.y;
            
            const extendedFingers = [thumbUp, indexUp, middleUp, ringUp, pinkyUp].filter(x => x).length;
            
            // Pointing gesture (only index finger up)
            if (indexUp && !middleUp && !ringUp && !pinkyUp) {
                return 'point';
            }
            
            // Thumbs up gesture (only thumb up)
            if (thumbUp && !indexUp && !middleUp && !ringUp && !pinkyUp) {
                return 'thumbs_up';
            }
            
            // Open hand gestures
            if (extendedFingers >= 4) {
                const wrist = landmarks[0];
                const handCenter = {
                    x: (thumb_tip.x + index_tip.x + middle_tip.x + ring_tip.x + pinky_tip.x) / 5,
                    y: (thumb_tip.y + index_tip.y + middle_tip.y + ring_tip.y + pinky_tip.y) / 5
                };
                
                // Determine hand direction based on finger positions relative to wrist
                if (handCenter.x < wrist.x - 0.05) {
                    return 'open_right';
                } else if (handCenter.x > wrist.x + 0.05) {
                    return 'open_left';
                }
            }
            
            // Closed fist (no fingers extended)
            if (extendedFingers === 0) {
                return 'fist';
            }
            
            return 'unknown';
        }

        function processGesture(gesture) {
            if (gesture === lastGesture || gestureDebounce) return;
            
            lastGesture = gesture;
            gestureDebounce = true;
            
            // Clear previous timeout
            if (gestureTimeout) clearTimeout(gestureTimeout);
            
            switch (gesture) {
                case 'point':
                    updateGestureStatus('👆 Pointing - Moving forward!');
                    move();
                    break;
                case 'open_left':
                    updateGestureStatus('✋ Open hand left - Turning left!');
                    turnLeft();
                    break;
                case 'open_right':
                    updateGestureStatus('✋ Open hand right - Turning right!');
                    turnRight();
                    break;
                case 'thumbs_up':
                    updateGestureStatus('👍 Thumbs up - Picking beeper!');
                    pickBeeper();
                    break;
                case 'fist':
                    updateGestureStatus('✊ Closed fist - Putting beeper!');
                    putBeeper();
                    break;
                default:
                    updateGestureStatus(`🤔 Gesture: ${gesture}`);
            }
            
            // Reset debounce after delay
            gestureTimeout = setTimeout(() => {
                gestureDebounce = false;
                lastGesture = '';
            }, 1000);
        }

        function updateGestureStatus(message) {
            document.getElementById('gestureStatus').textContent = message;
        }

        async function toggleGestureControl() {
            const button = document.getElementById('gestureToggle');
            
            if (!gestureEnabled) {
                button.disabled = true;
                button.textContent = '⏳ Loading...';
                updateGestureStatus('📷 Setting up camera...');
                const cameraReady = await setupCamera();
                
                if (cameraReady) {
                    updateGestureStatus('🤖 Loading hand detection model...');
                    setupHandDetection();
                    gestureEnabled = true;
                    button.textContent = '🛑 Disable Gesture Control';
                    button.style.background = 'linear-gradient(45deg, #ff6b6b, #ff5252)';
                    updateGestureStatus('✅ Gesture control active! Show your hand to the camera.');
                } else {
                    updateGestureStatus('❌ Failed to access camera');
                }
                button.disabled = false;
            } else {
                // Stop camera
                const stream = video.srcObject;
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    video.srcObject = null;
                }
                
                gestureEnabled = false;
                button.textContent = '🤚 Enable Gesture Control';
                button.style.background = 'linear-gradient(45deg, #00d4ff, #0099cc)';
                updateGestureStatus('🚫 Gesture control disabled');
            }
        }

        // Keyboard controls
        document.addEventListener('keydown', function(event) {
            switch(event.key.toLowerCase()) {
                case 'w':
                case 'arrowup':
                    event.preventDefault();
                    move();
                    break;
                case 'a':
                case 'arrowleft':
                    event.preventDefault();
                    turnLeft();
                    break;
                case 'd':
                case 'arrowright':
                    event.preventDefault();
                    turnRight();
                    break;
                case 's':
                case 'arrowdown':
                    event.preventDefault();
                    pickBeeper();
                    break;
                case ' ':
                    event.preventDefault();
                    putBeeper();
                    break;
            }
        });

        // Start the game
        initGame();
    </script>
</body>
</html>